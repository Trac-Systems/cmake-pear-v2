#include <pear.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>
#if defined(_WIN32) || defined(_WIN64)
#include <windows.h>
#include <appmodel.h>
#ifndef APPMODEL_ERROR_NO_PACKAGE
#define APPMODEL_ERROR_NO_PACKAGE 15700L
#endif
#endif
static int
contains_case_insensitive(const char *haystack, const char *needle) {
  size_t i;
  size_t j;
  if (!haystack || !needle || !needle[0]) return 0;
  for (i = 0; haystack[i]; i++) {
    for (j = 0; needle[j]; j++) {
      unsigned char hc = (unsigned char) haystack[i + j];
      unsigned char nc = (unsigned char) needle[j];
      if (!hc) return 0;
      if (tolower(hc) != tolower(nc)) break;
    }
    if (!needle[j]) return 1;
  }
  return 0;
}
static int
is_msix_redirected_path(const char *path) {
  return contains_case_insensitive(path, "\\packages\\") ||
         contains_case_insensitive(path, "/packages/") ||
         contains_case_insensitive(path, "\\localcache\\local") ||
         contains_case_insensitive(path, "/localcache/local");
}
#if defined(_WIN32) || defined(_WIN64)
static int
is_packaged_process(void) {
  UINT32 len = 0;
  LONG rc = GetCurrentPackageFullName(&len, NULL);
  if (rc == APPMODEL_ERROR_NO_PACKAGE) return 0;
  if (rc == ERROR_CALL_NOT_IMPLEMENTED) return 0;
  return 1;
}
static char *
dup_env_var(const char *name) {
  char buf[512];
  DWORD len = GetEnvironmentVariableA(name, buf, sizeof(buf));
  if (len == 0 || len >= sizeof(buf)) return NULL;
  char *out = (char *) malloc(len + 1);
  if (!out) return NULL;
  memcpy(out, buf, len);
  out[len] = '\0';
  return out;
}
static char *
resolve_programdata_path(void) {
  char *path = dup_env_var("ProgramData");
  if (!path) path = dup_env_var("ALLUSERSPROFILE");
  if (!path) {
    char drive[32];
    DWORD len = GetEnvironmentVariableA("SystemDrive", drive, sizeof(drive));
    if (len > 0 && len < sizeof(drive)) {
      size_t total = len + strlen("\\ProgramData") + 1;
      path = (char *) malloc(total);
      if (path) {
        snprintf(path, total, "%s\\ProgramData", drive);
      }
    }
  }
  return path;
}
#endif
static const char *
resolve_platform_path(void) {
  const char *rel = "@PEAR_PLATFORM_PATH@";
  if (rel == NULL || rel[0] == '\0') return NULL;
#if defined(_WIN32) || defined(_WIN64)
  const char *home = NULL;
  char *home_buf = NULL;
  const char *local = getenv("LOCALAPPDATA");
  const char *appdata = getenv("APPDATA");
  int local_redirected = local && local[0] && is_msix_redirected_path(local);
  int appdata_redirected = appdata && appdata[0] && is_msix_redirected_path(appdata);
  int packaged = is_packaged_process();
  int prefer_program = packaged || local_redirected || appdata_redirected;
  if (prefer_program) {
    home_buf = resolve_programdata_path();
    if (home_buf && home_buf[0]) {
      home = home_buf;
    } else if (home_buf) {
      free(home_buf);
      home_buf = NULL;
    }
  }
  if (home == NULL || home[0] == '\0') {
    if (local && local[0] && !local_redirected) {
      int local_abs = (local[0] == '\\' || (strlen(local) > 1 && local[1] == ':'));
      if (local_abs) home = local;
    }
  }
  if (home == NULL || home[0] == '\0') {
    if (appdata && appdata[0] && !appdata_redirected) {
      int home_abs = (appdata[0] == '\\' || (strlen(appdata) > 1 && appdata[1] == ':'));
      if (home_abs) home = appdata;
    }
  }
  if (home == NULL || home[0] == '\0') {
    const char *user = getenv("USERPROFILE");
    if (user && user[0]) {
      size_t base_len = strlen(user) + 1 + strlen("AppData\\Local") + 1;
      home_buf = (char *) malloc(base_len);
      if (home_buf) {
        snprintf(home_buf, base_len, "%s\\AppData\\Local", user);
        home = home_buf;
      }
    }
  }
  const char sep = '\\';
  int is_abs = (rel[0] == '\\' || (strlen(rel) > 1 && rel[1] == ':'));
#else
  const char *home = getenv("HOME");
  const char sep = '/';
  int is_abs = (rel[0] == '/');
#endif
  if (is_abs || home == NULL || home[0] == '\0') {
    if (home_buf) free(home_buf);
    return rel;
  }
  size_t len = strlen(home) + 1 + strlen(rel) + 1;
  char *buf = (char *) malloc(len);
  if (!buf) {
    if (home_buf) free(home_buf);
    return rel;
  }
  snprintf(buf, len, "%s%c%s", home, sep, rel);
  if (home_buf) free(home_buf);
  return buf;
}
int
main(int argc, char *argv[]) {
  pear_id_t id = "@PEAR_ID@";
  const char *name = "@PEAR_NAME@";
  // Use app-specific platform directory to avoid sharing pear runtime with other apps.
  pear_path = resolve_platform_path();
  return pear_launch(argc, argv, id, name);
}
